<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>증강 영상 그리드 뷰</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#10192b; --panel:#111a2b; --text:#f1faff;
      --accent:#87f0ff; --accent-2:#63e3ff;
      --primary-grad:linear-gradient(95deg,#2feaff,#25c7c2);
      --line:rgba(99,227,255,.25); --line-dim:rgba(99,227,255,.12);
      --shadow-color:rgba(47,234,255,.15);
      --hi:#00ffd5; /* 짙은 민트 하이라이트 */
    }
    html,body{
      margin:0; padding:0; width:100%; min-height:100%;
      font-family:'Inter',sans-serif; color:var(--text);
      background:var(--bg); overflow-y:auto; overflow-x:hidden;
    }
    .bg-blur-img{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover;filter:brightness(.48) blur(2.2px) grayscale(8%);z-index:0;pointer-events:none;opacity:.97}
    .bg-overlay{position:fixed;inset:0;background:radial-gradient(ellipse at 55% 33%, rgba(36,197,246,.16) 0, rgba(11,24,40,.985) 60%);z-index:1;pointer-events:none}
    .bg-pattern{position:fixed;inset:0;background-image:repeating-linear-gradient(120deg, rgba(80,255,255,.018) 0 1px, transparent 1px 60px);opacity:.22;z-index:2;pointer-events:none}

    .top-wrap{position:relative;z-index:10;width:100%;display:flex;flex-direction:column;align-items:center;padding-top:78px;margin-bottom:26px}
    .dashboard-title-bar{
      display:flex;align-items:center;gap:14px;font-size:2rem;font-weight:900;color:#87f0ff;letter-spacing:2px;
      background:linear-gradient(90deg,#51e6fc3a 0 70%,transparent 100%);
      border-radius:14px;box-shadow:0 6px 32px #38d6e45c;
      padding:14px 28px 14px 16px;border-left:6px solid #25fff7;border-bottom:2px solid #22e3db30;
      max-width:1280px;width:calc(100% - 40px);
    }
    .subtitle{
      margin-top:14px;font-weight:900;letter-spacing:.02em;color:#e8fbff;
      background:rgba(13,18,28,.58);border:1.5px solid var(--line);
      padding:14px 22px;border-radius:14px;backdrop-filter:blur(8px);
      box-shadow:0 6px 20px rgba(0,0,0,.25),0 0 0 1px rgba(255,255,255,.03) inset;
      font-size:clamp(18px, 2.2vw, 28px);
    }

    .page-wrap{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;gap:18px}
    .stage{
      width:min(94vw,1280px);aspect-ratio:16/9;border-radius:16px;border:1px solid var(--line-dim);
      box-shadow:0 10px 40px -5px #0000004d,0 0 0 1px var(--line-dim) inset;
      overflow:hidden;background:var(--panel);transform:scale(.985);opacity:0;
      animation:stageIn .55s cubic-bezier(.16,1,.3,1) .1s forwards;
      position:relative;
    }
    @keyframes stageIn{to{transform:scale(1);opacity:1}}

    .grid-container,.solo-container{position:absolute;inset:0;opacity:0;animation:contentIn .45s ease .15s forwards}
    @keyframes contentIn{to{opacity:1}}
    .grid-container{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr}
    .cell{position:relative;overflow:hidden;border:1px solid var(--line-dim);cursor:pointer;transition:transform .15s ease}
    .cell:active{transform:scale(.995)}
    .cell::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at center,transparent,rgba(135,240,255,.20) 260%);opacity:0;transition:opacity .2s ease;pointer-events:none}
    .cell:hover::after{opacity:.6}
    .badge{position:absolute;top:8px;left:8px;font-size:.78rem;font-weight:800;padding:4px 8px;border-radius:8px;background:rgba(13,18,28,.65);color:#9fe9ff;border:1px solid var(--line-dim);z-index:3}

    .caption{
      position:absolute;left:0;right:0;bottom:0;
      background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 60%, rgba(0,0,0,.65) 100%);
      padding:14px 16px;
      display:flex;align-items:center;z-index:2;
      border-top:1px solid rgba(255,255,255,.06)
    }
    .cap-text{
      font-weight:900;letter-spacing:.02em;color:#dcfbff;
      font-size:clamp(16px, 1.8vw, 26px);
    }
    video{width:100%;height:100%;object-fit:cover;display:block;transition:filter .25s ease}

    .placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg, rgba(99,227,255,.08), rgba(37,199,194,.06)),repeating-linear-gradient(45deg, rgba(255,255,255,.03) 0 12px, transparent 12px 24px);
      color:#c7f3ff;font-weight:900;letter-spacing:.03em;font-size:1.05rem;
    }

    .cell-toast{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      padding:10px 14px;border-radius:10px;background:rgba(13,18,28,.7);border:1px solid var(--line);
      font-weight:900;color:#c9f7ff;z-index:5;opacity:0;
      animation:toastIn .35s ease forwards, toastOut .45s ease 1.2s forwards;
      pointer-events:none;white-space:nowrap;
    }
    @keyframes toastIn{to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    @keyframes toastOut{to{opacity:0}}

    .controls{
      position:fixed;left:50%;bottom:64px;transform:translateX(-50%);
      display:flex;gap:12px;z-index:11;backdrop-filter:blur(10px);
      background:rgba(13,18,28,.56);padding:8px 10px;border-radius:12px;border:1px solid var(--line-dim);
      box-shadow:0 4px 10px #00000033;
    }
    .btn{background:#152238;color:#d2faff;border:1px solid var(--line-dim);padding:10px 20px;font-weight:700;border-radius:10px;cursor:pointer;font-size:1rem;box-shadow:0 2px 4px #00000033;transition:all .15s ease}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px var(--shadow-color);border-color:var(--line);color:#fff}
    .btn:active{transform:translateY(0) scale(.97)}
    .btn-primary{background:var(--primary-grad);color:#002b38;border:none}

    .footer-info{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);display:flex;gap:10px;background:rgba(13,18,28,.56);padding:8px 15px;border-radius:12px;border:1px solid var(--line-dim);box-shadow:0 4px 10px #00000033;z-index:11}
    .pill{font-size:.85rem;padding:5px 12px;border-radius:999px;background:#152238;border:1px solid var(--line);color:#63e3ff;font-weight:700}

    .spacer{height:1200px}

    /* ======= 4×4(단일 영상)용 오버레이 ======= */
    .solo-container{position:absolute;inset:0}
    .quad-overlay{position:absolute;inset:0;pointer-events:none;z-index:3}
    .quad-overlay .vline,
    .quad-overlay .hline{
      position:absolute;background:linear-gradient(180deg, transparent, rgba(135,240,255,.6), transparent);
      box-shadow:0 0 18px rgba(47,234,255,.18);
      opacity:.8;
    }
    .quad-overlay .vline{top:0;bottom:0;width:2px;left:50%;transform:translateX(-1px);background:linear-gradient(180deg,transparent,rgba(135,240,255,.55),transparent)}
    .quad-overlay .hline{left:0;right:0;height:2px;top:50%;transform:translateY(-1px);background:linear-gradient(90deg,transparent,rgba(135,240,255,.55),transparent)}
    .quad-label{
      position:absolute;transform:translate(-50%,-50%);
      padding:6px 12px;border-radius:10px;
      background:rgba(13,18,28,.65);border:1px solid var(--line);
      color:#c9f7ff;font-weight:900;letter-spacing:.02em;
      font-size:clamp(16px, 1.5vw, 22px);
      text-shadow:0 1px 0 #000; box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    .quad-tl{left:25%; top:25%} .quad-tr{left:75%; top:25%}
    .quad-bl{left:25%; top:75%} .quad-br{left:75%; top:75%}

    /* ======= 클릭 하이라이트 (테두리 + 내부 민트 채움, 발표용 강하게) ======= */
    .cell.highlighted{
      outline:4px solid var(--hi);
      outline-offset:-4px;
      box-shadow:
        0 0 0 2px rgba(0,0,0,.25) inset,
        0 0 24px rgba(0,255,213,.65),
        0 0 48px rgba(0,255,213,.45);
    }
    .cell.highlighted::before{
      content:""; position:absolute; inset:0;
      background:
        radial-gradient(120% 120% at 50% 50%, rgba(0,255,213,.28) 0%, rgba(0,255,213,.18) 55%, rgba(0,255,213,.08) 85%, transparent 100%),
        linear-gradient(180deg, rgba(0,255,213,.14), rgba(0,255,213,.10));
      mix-blend-mode:screen;
      pointer-events:none;
    }
    .cell.highlighted video{ filter:brightness(1.30) contrast(1.18) saturate(1.12); }
  </style>
</head>
<body>
  <img class="bg-blur-img" src="{{ url_for('static', filename='images/back3.jpg') }}" alt="Background" />
  <div class="bg-overlay"></div>
  <div class="bg-pattern"></div>

  <div class="top-wrap">
    <div class="dashboard-title-bar"><span class="dot">●</span> DATA AUGMENTATION OUTPUT DASHBOARD</div>
    <div class="subtitle" id="subtitle">장소별 프리뷰 · 2×2</div>
  </div>

  <div class="page-wrap">
    <main class="stage" id="stage"></main>
  </div>

  <nav class="controls" id="controls"></nav>
  <div class="footer-info">
    <span class="pill" id="layout-pill"></span>
    <span class="pill">ESC: 창 닫기</span>
  </div>

  <div class="spacer"></div>

  <script>
    const USE_PLACEHOLDER = false;

    const videos = {
      rooftop: {
        '2x2': {
          r1c1: '{{ url_for("static", filename="images/1.mp4") }}',
          r1c2: '{{ url_for("static", filename="images/2.mp4") }}',
          r2c1: '{{ url_for("static", filename="images/3.mp4") }}',
          r2c2: '{{ url_for("static", filename="images/4.mp4") }}',
        },
        '4x4': '{{ url_for("static", filename="images/future.mp4") }}',
        '8x8': '{{ url_for("static", filename="images/4.mp4") }}'
      }
    };

    const params = new URLSearchParams(window.location.search);
    const locationName = params.get('location') || 'rooftop';
    const initialLayout = (params.get('layout') || '2x2').toLowerCase();

    const stageEl = document.getElementById('stage');
    const controlsEl = document.getElementById('controls');
    const layoutPill = document.getElementById('layout-pill');
    const subtitleEl = document.getElementById('subtitle');

    let currentCaption = '장소별 프리뷰';
    let transitioning = false;

    const setSubtitle = (text) => { subtitleEl.textContent = text; };

    // ▶ 2×2는 항상 Places, 그 외(4×4/8×8)는 currentCaption (기본값이면 Places)
    function setPill(layout){
      const base = (layout === '2x2' || currentCaption === '장소별 프리뷰')
        ? 'Places'
        : currentCaption;
      layoutPill.textContent = `Layout: ${layout.toUpperCase()} — ${base}`;
    }

    function layoutTitle(base, layout){
      const sym = layout.replace('x','×');
      if (layout === '4x4' && base !== '장소별 프리뷰') {
        return `${base} - Front · Side · Back · ${sym} View`;
      }
      return `${base} · ${sym} View`;
    }

    function makeBtn(text, className, onClick) {
      const b = document.createElement('button');
      b.className = className;
      b.textContent = text;
      b.addEventListener('click', onClick);
      controlsEl.appendChild(b);
    }

    function showCellPreviewToast(cell, label){
      const toast = document.createElement('div');
      toast.className = 'cell-toast';
      toast.textContent = `${label} · 4×4 View`;
      cell.appendChild(toast);
      setTimeout(()=>toast.remove(), 1600);
    }

    function clearHighlights(){
      document.querySelectorAll('.cell.highlighted').forEach(c => c.classList.remove('highlighted'));
    }

    function highlightCellStrong(cell){
      clearHighlights();
      cell.classList.add('highlighted');
      setTimeout(() => cell.classList.remove('highlighted'), 1500);
    }

    function renderLayout(layout, opts = {}) {
      stageEl.innerHTML = '';
      controlsEl.innerHTML = '';

      setPill(layout);

      if (opts.subtitleText) setSubtitle(opts.subtitleText);
      else setSubtitle(layoutTitle(currentCaption, layout));

      const locationVideos = videos[locationName] || videos.rooftop;

      if (layout === '2x2') {
        transitioning = false;

        const sources = locationVideos['2x2'] || {};
        const grid = document.createElement('div');
        grid.className = 'grid-container';

        const captions = { r1c1:'Future', r1c2:'Rooftop', r2c1:'Construction Site', r2c2:'Space' };

        [['r1c1','1-1'], ['r1c2','1-2'], ['r2c1','2-1'], ['r2c2','2-2']].forEach(([key, label]) => {
          const src = sources[key] || '';
          const cell = document.createElement('div');
          cell.className = 'cell';

          cell.innerHTML = (!USE_PLACEHOLDER && src)
            ? `<video src="${src}" autoplay loop muted playsinline></video>`
            : `<div class="placeholder">NO VIDEO</div>`;

          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = label;
          cell.appendChild(badge);

          const cap = document.createElement('div');
          cap.className = 'caption';
          cap.innerHTML = `<span class="cap-text">${captions[key]}</span>`;
          cell.appendChild(cap);

          cell.addEventListener('click', () => {
            if (transitioning) return;
            transitioning = true;

            currentCaption = captions[key]; // ← 예: 'Future'
            highlightCellStrong(cell);
            showCellPreviewToast(cell, currentCaption);

            setSubtitle(layoutTitle(currentCaption, '4x4'));
            setTimeout(() => {
              renderLayout('4x4', { subtitleText: layoutTitle(currentCaption, '4x4') });
            }, 520);
          });

          grid.appendChild(cell);
        });

        stageEl.appendChild(grid);

        makeBtn('증강 → 4×4', 'btn btn-primary', () => {
          // 셀 선택 없이 버튼만 누르면 Places 유지
          currentCaption = '장소별 프리뷰';
          setSubtitle(layoutTitle(currentCaption, '4x4'));
          renderLayout('4x4', { subtitleText: layoutTitle(currentCaption, '4x4') });
        });
        makeBtn('닫기', 'btn', () => window.close());

      } else {
        const src = locationVideos[layout] || '';
        const solo = document.createElement('div');
        solo.className = 'solo-container';
        solo.innerHTML = (!USE_PLACEHOLDER && src)
          ? `<video src="${src}" autoplay loop muted playsinline></video>`
          : `<div class="placeholder">PREVIEW ${layout.toUpperCase()}</div>`;
        stageEl.appendChild(solo);

        if (layout === '4x4') {
          const overlay = document.createElement('div');
          overlay.className = 'quad-overlay';
          overlay.innerHTML = `
            <div class="vline"></div>
            <div class="hline"></div>
            <div class="quad-label quad-tl">Right Side</div>
            <div class="quad-label quad-tr">Front</div>
            <div class="quad-label quad-bl">Left Side</div>
            <div class="quad-label quad-br">Back</div>
          `;
          solo.appendChild(overlay);

          makeBtn('증강 → 8×8', 'btn btn-primary', () => {
            setSubtitle(layoutTitle(currentCaption, '8x8'));
            renderLayout('8x8', { subtitleText: layoutTitle(currentCaption, '8x8') });
          });
          makeBtn('이전 (2×2)', 'btn', () => {
            currentCaption = '장소별 프리뷰';
            setSubtitle(layoutTitle(currentCaption, '2x2'));
            renderLayout('2x2', { subtitleText: layoutTitle(currentCaption, '2x2') });
          });
        } else {
          makeBtn('초기화 (2×2)', 'btn btn-primary', () => {
            currentCaption = '장소별 프리뷰';
            setSubtitle(layoutTitle(currentCaption, '2x2'));
            renderLayout('2x2', { subtitleText: layoutTitle(currentCaption, '2x2') });
          });
          makeBtn('이전 (4×4)', 'btn', () => {
            setSubtitle(layoutTitle(currentCaption, '4x4'));
            renderLayout('4x4', { subtitleText: layoutTitle(currentCaption, '4x4') });
          });
        }
      }
    }

    renderLayout(initialLayout);
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') window.close(); });
  </script>
</body>
</html>
